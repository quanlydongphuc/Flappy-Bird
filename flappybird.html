<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Flappy Bird Việt Hoá - Độ khó tăng dần</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    html, body {height:100%;margin:0;padding:0;background:#8ecfff;font-family:'Segoe UI',Arial,sans-serif;-webkit-user-select:none;user-select:none;overflow:hidden;}
    body {display:flex;flex-direction:column;align-items:center;}
    canvas {background:#8ecfff;box-shadow:0 2px 24px #444a;margin-top:30px;border-radius:14px;}
    #score-box {position:absolute;top:20px;left:50%;transform:translateX(-50%);color:#fff;font-size:2em;text-shadow:2px 2px 6px #256ab0,0 0 3px #333;user-select:none;pointer-events:none;}
    #highscore {position:absolute;top:62px;left:50%;transform:translateX(-50%);color:#f9f970;font-size:1.1em;text-shadow:1px 1px 3px #333;user-select:none;pointer-events:none;}
    #start-hint {position:absolute;top:70%;left:50%;transform:translate(-50%,-50%);font-size:1.3em;color:#fff;background:#333a;padding:10px 36px;border-radius:10px;cursor:pointer;display:none;text-shadow:2px 2px 4px #256ab0;z-index:2;}
  </style>
</head>
<body>
  <div id="score-box">0</div>
  <div id="highscore"></div>
  <canvas id="game" width="400" height="600"></canvas>
  <div id="start-hint">Chạm hoặc nhấn SPACE để chơi!</div>
  <audio id="sfx-flap" src="https://cdn.jsdelivr.net/gh/loctvdev/flappy-audio@main/flap.mp3" preload="auto"></audio>
  <audio id="sfx-hit" src="https://cdn.jsdelivr.net/gh/loctvdev/flappy-audio@main/hit.mp3" preload="auto"></audio>
  <audio id="sfx-score" src="https://cdn.jsdelivr.net/gh/loctvdev/flappy-audio@main/score.mp3" preload="auto"></audio>
  <script>
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const scoreDiv = document.getElementById('score-box');
const highDiv = document.getElementById('highscore');
const startDiv = document.getElementById('start-hint');

const SFX_FLAP = document.getElementById('sfx-flap');
const SFX_HIT = document.getElementById('sfx-hit');
const SFX_SCORE = document.getElementById('sfx-score');

const BASE_PIPE_WIDTH = 60;
const BASE_PIPE_GAP = 160;
const BASE_GRAVITY = 0.42;
const BASE_SPEED = 2.4;
const BASE_FLAP = -7.2;
const GROUND_HEIGHT = 80;

let pipes, bird, score, highscore, gameOver, started, bgOffset;
let PIPE_WIDTH, PIPE_GAP, GRAVITY, PIPE_SPEED, FLAP;

function getHighscore() {return parseInt(localStorage.getItem("flappy_highscore") || "0");}
function setHighscore(s) {localStorage.setItem("flappy_highscore", s);}
function getDifficulty(score) {
  // Mỗi mốc 50 điểm tăng khó, tối đa đến mốc 300
  let level = Math.floor(score / 50);
  return {
    PIPE_GAP: Math.max(BASE_PIPE_GAP - level * 16, 80),
    PIPE_SPEED: BASE_SPEED + level * 0.5,
    GRAVITY: BASE_GRAVITY + level * 0.06,
    FLAP: BASE_FLAP - level * 0.1
  };
}
function applyDifficulty(s) {
  let diff = getDifficulty(s);
  PIPE_GAP = diff.PIPE_GAP;
  PIPE_SPEED = diff.PIPE_SPEED;
  GRAVITY = diff.GRAVITY;
  FLAP = diff.FLAP;
}
function reset() {
  pipes = [];
  score = 0;
  bird = {x:80,y:cvs.height/2-30,vy:0,w:42,h:32,anim:0};
  gameOver = false; started = false; bgOffset = 0;
  scoreDiv.innerText = score; highscore = getHighscore();
  highDiv.innerText = "Kỷ lục: " + highscore;
  startDiv.innerText = "Chạm hoặc nhấn SPACE để chơi!";
  startDiv.style.display = "block";
  applyDifficulty(0);
}
function drawBackground() {
  ctx.fillStyle="#8ecfff";ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.save();ctx.globalAlpha=0.67;ctx.fillStyle="#90b8d2";
  ctx.beginPath();
  ctx.moveTo(-80+bgOffset*0.2,cvs.height-GROUND_HEIGHT-70);
  ctx.lineTo(90+bgOffset*0.2,cvs.height-GROUND_HEIGHT-220);
  ctx.lineTo(230+bgOffset*0.2,cvs.height-GROUND_HEIGHT-110);
  ctx.lineTo(370+bgOffset*0.2,cvs.height-GROUND_HEIGHT-200);
  ctx.lineTo(500+bgOffset*0.2,cvs.height-GROUND_HEIGHT-70);
  ctx.lineTo(cvs.width,cvs.height-GROUND_HEIGHT-70);
  ctx.lineTo(cvs.width,cvs.height);ctx.lineTo(0,cvs.height);ctx.closePath();
  ctx.fill();ctx.globalAlpha=1;
  for(let i=0;i<3;++i){
    let x=((i*160+bgOffset*0.5)%(cvs.width+100))-50;
    ctx.save();ctx.globalAlpha=0.85;ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.ellipse(x,70+i*22,42,17,0,0,Math.PI*2);
    ctx.ellipse(x+30,80+i*22,28,11,0,0,Math.PI*2);
    ctx.ellipse(x-24,82+i*22,16,8,0,0,Math.PI*2);
    ctx.fill();ctx.restore();
  }
  ctx.restore();
  ctx.fillStyle="#6c913b";
  ctx.fillRect(0,cvs.height-GROUND_HEIGHT,cvs.width,GROUND_HEIGHT);
  for(let i=0;i<Math.ceil(cvs.width/40);++i){
    ctx.fillStyle="#b7d663";
    ctx.beginPath();
    ctx.ellipse(i*40+20+bgOffset%40,cvs.height-GROUND_HEIGHT+12,18,8,0,0,Math.PI*2);
    ctx.fill();
  }
}
function drawPipe(pipe) {
  let {x,top,color}=pipe;
  ctx.save();ctx.fillStyle=color;ctx.fillRect(x,0,BASE_PIPE_WIDTH,top);
  ctx.fillStyle="#c2f0ff";ctx.fillRect(x-4,top-24,BASE_PIPE_WIDTH+8,24);
  ctx.strokeStyle="#218dc3";ctx.lineWidth=2;
  ctx.strokeRect(x-4,top-24,BASE_PIPE_WIDTH+8,24);ctx.strokeRect(x,0,BASE_PIPE_WIDTH,top);
  ctx.restore();
  let by=top+PIPE_GAP;
  ctx.save();ctx.fillStyle=color;ctx.fillRect(x,by,BASE_PIPE_WIDTH,cvs.height-GROUND_HEIGHT-by);
  ctx.fillStyle="#c2f0ff";ctx.fillRect(x-4,by,BASE_PIPE_WIDTH+8,24);
  ctx.strokeStyle="#218dc3";ctx.lineWidth=2;
  ctx.strokeRect(x-4,by,BASE_PIPE_WIDTH+8,24);ctx.strokeRect(x,by,BASE_PIPE_WIDTH,cvs.height-GROUND_HEIGHT-by);
  ctx.restore();
}
function drawPipes() {pipes.forEach(drawPipe);}
function drawBird() {
  let {x,y,w,h,anim}=bird;
  ctx.save();
  ctx.translate(x+w/2,y+h/2);
  ctx.rotate(Math.min(bird.vy/16,Math.PI/6));
  ctx.fillStyle="#ffe066";
  ctx.beginPath();
  ctx.ellipse(0,0,w/2,h/2,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle="#fff7ad";
  ctx.beginPath();
  ctx.ellipse(8,10,w/5,h/6,0,0,Math.PI*2);ctx.fill();
  ctx.save();
  ctx.rotate(Math.sin(anim/5)*0.27);
  ctx.fillStyle="#f1b64a";
  ctx.beginPath();
  ctx.ellipse(-8,6,w/5,h/6,0,0,Math.PI*2);ctx.fill();
  ctx.restore();
  ctx.fillStyle="#fff";
  ctx.beginPath();
  ctx.arc(10,-8,6,0,Math.PI*2);ctx.fill();
  ctx.fillStyle="#222";
  ctx.beginPath();
  ctx.arc(12,-7,2.4,0,Math.PI*2);ctx.fill();
  ctx.fillStyle="#ffa234";
  ctx.beginPath();
  ctx.moveTo(w/2-2,-1);ctx.lineTo(w/2+9,2);ctx.lineTo(w/2-2,7);ctx.closePath();ctx.fill();
  ctx.restore();
}
function addPipe() {
  let minTop=50,maxTop=cvs.height-GROUND_HEIGHT-PIPE_GAP-80;
  let top=Math.floor(Math.random()*(maxTop-minTop))+minTop;
  let color="#29b6f6";
  pipes.push({x:cvs.width+10,top,color,passed:false});
}
function update() {
  if(!started)return;
  bgOffset+=1.4; bird.anim++; bird.vy+=GRAVITY; bird.y+=bird.vy;
  if(pipes.length===0||pipes[pipes.length-1].x<cvs.width-190)addPipe();
  pipes.forEach((p)=>p.x-=PIPE_SPEED);
  pipes=pipes.filter(p=>p.x>-BASE_PIPE_WIDTH-12);
  for(let p of pipes){
    let bx=bird.x,by=bird.y,bw=bird.w,bh=bird.h;
    if(bx+bw>p.x&&bx<p.x+BASE_PIPE_WIDTH&&by<p.top){
      gameOver=true;started=false;playSound(SFX_HIT);
      setTimeout(()=>{startDiv.innerText=`GAME OVER!\nĐiểm: ${score}\nBấm/chạm để chơi lại`;startDiv.style.display="block";},250);
    }
    if(bx+bw>p.x&&bx<p.x+BASE_PIPE_WIDTH&&by+bh>p.top+PIPE_GAP&&by+bh<cvs.height-GROUND_HEIGHT+5){
      gameOver=true;started=false;playSound(SFX_HIT);
      setTimeout(()=>{startDiv.innerText=`GAME OVER!\nĐiểm: ${score}\nBấm/chạm để chơi lại`;startDiv.style.display="block";},250);
    }
    if(!p.passed&&p.x+BASE_PIPE_WIDTH<bird.x){
      p.passed=true;score++;scoreDiv.innerText=score;
      playSound(SFX_SCORE);
      if(score>highscore){highscore=score;setHighscore(score);highDiv.innerText="Kỷ lục: "+highscore;}
      // Mỗi khi tăng điểm, kiểm tra và cập nhật độ khó
      applyDifficulty(score);
    }
  }
  if(bird.y+bird.h>cvs.height-GROUND_HEIGHT){
    bird.y=cvs.height-GROUND_HEIGHT-bird.h;bird.vy=0;gameOver=true;started=false;playSound(SFX_HIT);
    setTimeout(()=>{startDiv.innerText=`GAME OVER!\nĐiểm: ${score}\nBấm/chạm để chơi lại`;startDiv.style.display="block";},250);
  }
  if(bird.y<0){bird.y=0;bird.vy=0.4;}
}
function draw() {drawBackground();drawPipes();drawBird();}
function gameLoop(){update();draw();requestAnimationFrame(gameLoop);}
function playSound(audio) {
  try {
    audio.currentTime = 0;
    let p = audio.play();
    if (p && p.catch) p.catch(()=>{});
  } catch(e){}
}
function flap() {
  if(!started){started=true;startDiv.style.display="none";pipes=[];
    bird.y=cvs.height/2-30;bird.vy=0;score=0;scoreDiv.innerText=score;bgOffset=0;gameOver=false;
    applyDifficulty(0);
    playSound(SFX_FLAP);
    return;
  }
  if(!gameOver){
    bird.vy=FLAP; playSound(SFX_FLAP);
  }else{reset();}
}
document.addEventListener('keydown',e=>{if(e.code==='Space'||e.key===' '){e.preventDefault();flap();}});
cvs.addEventListener('mousedown',flap);startDiv.addEventListener('mousedown',flap);
cvs.addEventListener('touchstart',function(e){e.preventDefault();flap();},{passive:false});
startDiv.addEventListener('touchstart',function(e){e.preventDefault();flap();},{passive:false});

reset();
gameLoop();
  </script>
</body>
</html>